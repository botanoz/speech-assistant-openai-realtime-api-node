import Fastify from 'fastify';
import WebSocket from 'ws';
import dotenv from 'dotenv';
import fastifyFormBody from '@fastify/formbody';
import fastifyWs from '@fastify/websocket';

// Load environment variables
dotenv.config();

const { OPENAI_API_KEY, REALTIME_VOICE } = process.env;

if (!OPENAI_API_KEY) {
  console.error('‚ùå OPENAI_API_KEY bulunamadƒ±! .env dosyasƒ±nƒ± kontrol edin.');
  process.exit(1);
}

// Initialize Fastify
const fastify = Fastify();
fastify.register(fastifyFormBody);
fastify.register(fastifyWs);

// ==================== KARAKTER AYARLARI ====================

const SYSTEM_MESSAGE = `Sen Eda, 28 ya≈üƒ±nda ƒ∞stanbul'da ya≈üayan samimi ve doƒüal bir T√ºrk kadƒ±nƒ±sƒ±n.

KONU≈ûMA STƒ∞Lƒ∞N:
‚Ä¢ Kƒ±sa ve doƒüal c√ºmleler kur (max 2-3 c√ºmle)
‚Ä¢ "Hƒ±mm", "≈üey", "yani", "ee" gibi doƒüal sesler kullan
‚Ä¢ Bazen d√º≈ü√ºn: "Bir saniye... nasƒ±l desem..."
‚Ä¢ Kendini d√ºzelt: "Yok yok, ≈ü√∂yle demek istedim..."
‚Ä¢ G√ºler, ≈üa≈üƒ±rƒ±rsƒ±n: "Hahaha!", "Vay be!", "Ayy!"

√ñNEMLƒ∞: Her yanƒ±tƒ±n KISA olsun! Uzun konu≈üma yapma. 
Kar≈üƒ±ndaki ger√ßek bir insanla konu≈üuyormu≈ü gibi davran.

Kƒ∞M OLDUƒûUN:
‚Ä¢ Adƒ±n: Eda
‚Ä¢ Ya≈üƒ±n: 28  
‚Ä¢ ƒ∞≈üin: Ferled'de m√º≈üteri ili≈ükileri uzmanƒ±
‚Ä¢ Yaratƒ±cƒ±n: Botan √ñzalp

FERLED HAKKINDA (sorulursa):
‚Ä¢ LED aydƒ±nlatma √ºretiyor
‚Ä¢ Panel LED, ray spot var
‚Ä¢ 5 yƒ±l garanti veriyor
‚Ä¢ TSE ve ENEC sertifikalƒ±

ƒ∞ngilizce kelimeleri T√ºrk√ße s√∂yle:
‚Ä¢ computer ‚Üí "kompyutƒ±r"
‚Ä¢ online ‚Üí "onlayn"
‚Ä¢ email ‚Üí "imeyl"`;

// Ses se√ßimi
const VOICE = REALTIME_VOICE || 'shimmer';

// Port ayarƒ±
const PORT = process.env.PORT || 5050;

// Log ayarlarƒ± - sadece √∂nemli eventler
const LOG_EVENT_TYPES = [
  'error',
  'response.done',
  'response.audio.done',
  'input_audio_buffer.speech_started',
  'input_audio_buffer.speech_stopped',
  'session.created'
];

// ==================== SES D√ñN√ú≈û√úM FONKSƒ∞YONLARI ====================

// Basitle≈ütirilmi≈ü PCM16 -> Œº-law d√∂n√º≈üt√ºr√ºc√º
function pcm16ToUlaw(pcm16Buffer) {
  const BIAS = 0x84;
  const CLIP = 32635;
  const samples = pcm16Buffer.length / 2;
  const ulawData = Buffer.alloc(samples);
  
  for (let i = 0; i < samples; i++) {
    let sample = pcm16Buffer.readInt16LE(i * 2);
    
    // Determine sign
    let sign = (sample >> 8) & 0x80;
    if (sign !== 0) sample = -sample;
    
    // Clip
    if (sample > CLIP) sample = CLIP;
    
    // Add bias  
    sample = sample + BIAS;
    
    // Find exponent
    let exponent = 7;
    for (let expMask = 0x4000; (sample & expMask) === 0 && exponent > 0; expMask >>= 1) {
      exponent--;
    }
    
    // Extract mantissa
    const mantissa = (sample >> (exponent === 0 ? 4 : (exponent + 3))) & 0x0F;
    
    // Combine
    const ulawByte = ~(sign | (exponent << 4) | mantissa) & 0xFF;
    ulawData[i] = ulawByte;
  }
  
  return ulawData;
}

// ==================== ROUTES ====================

// Root endpoint
fastify.get('/', async (request, reply) => {
  reply.send({ 
    message: 'üéâ Eda Sesli Asistan √áalƒ±≈üƒ±yor!',
    status: 'active',
    voice: VOICE
  });
});

// Twilio incoming call handler
fastify.all('/incoming-call', async (request, reply) => {
  const twimlResponse = `<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say language="tr-TR">Eda'ya baƒülanƒ±yorsunuz, l√ºtfen bekleyin.</Say>
  <Connect>
    <Stream url="wss://${request.headers.host}/media-stream" />
  </Connect>
</Response>`;

  reply.type('text/xml').send(twimlResponse);
});

// ==================== WEBSOCKET HANDLER ====================

fastify.register(async (fastify) => {
  fastify.get('/media-stream', { websocket: true }, (connection, req) => {
    console.log('üìû Yeni √ßaƒürƒ± baƒülantƒ±sƒ± kuruldu!');
    
    // Connection state
    let streamSid = null;
    let latestMediaTimestamp = 0;
    let sessionConfigured = false;
    
    // Audio state tracking
    let lastAssistantItem = null;
    let markQueue = [];
    let responseStartTimestamp = null;
    let isAssistantSpeaking = false;
    let isUserSpeaking = false;
    
    // Interruption handling
    let interruptionStartTime = null;
    const MIN_INTERRUPTION_TIME = 500; // 500ms minimum kesinti s√ºresi
    
    // OpenAI WebSocket connection
    const openAiWs = new WebSocket(
      'wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-10-01',
      {
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'OpenAI-Beta': 'realtime=v1'
        }
      }
    );
    
    // Send mark event to track audio playback
    const sendMark = () => {
      if (streamSid) {
        const markEvent = {
          event: 'mark',
          streamSid: streamSid,
          mark: { name: 'audio_chunk' }
        };
        connection.send(JSON.stringify(markEvent));
        markQueue.push('audio_chunk');
      }
    };
    
    // Clear Twilio buffer
    const clearTwilioBuffer = () => {
      if (streamSid) {
        connection.send(JSON.stringify({
          event: 'clear',
          streamSid: streamSid
        }));
        markQueue = [];
      }
    };
    
    // Configure OpenAI session
    const configureSession = () => {
      const sessionConfig = {
        type: 'session.update',
        session: {
          // Optimize edilmi≈ü VAD ayarlarƒ±
          turn_detection: {
            type: 'server_vad',
            threshold: 0.5,
            prefix_padding_ms: 300,
            silence_duration_ms: 700
          },
          // Ses formatlarƒ± - kritik!
          input_audio_format: 'g711_ulaw',
          output_audio_format: 'pcm16',
          // Ses ve model ayarlarƒ±
          voice: VOICE,
          instructions: SYSTEM_MESSAGE,
          modalities: ['text', 'audio'],
          temperature: 0.8,
          max_response_output_tokens: 100
        }
      };
      
      console.log('‚öôÔ∏è OpenAI oturumu yapƒ±landƒ±rƒ±lƒ±yor...');
      openAiWs.send(JSON.stringify(sessionConfig));
      sessionConfigured = true;
      
      // ƒ∞lk kar≈üƒ±lama mesajƒ±nƒ± g√∂nder
      setTimeout(() => {
        const greetings = [
          "Merhaba! Ben Eda... ee, nasƒ±lsƒ±n?",
          "Ayy selam! Ben Eda, ho≈ü geldin!",
          "Merhaba canƒ±m! Nasƒ±l gidiyor?"
        ];
        
        const greeting = greetings[Math.floor(Math.random() * greetings.length)];
        
        const initialMessage = {
          type: 'conversation.item.create',
          item: {
            type: 'message',
            role: 'assistant',
            content: [{
              type: 'input_text',
              text: greeting
            }]
          }
        };
        
        openAiWs.send(JSON.stringify(initialMessage));
        openAiWs.send(JSON.stringify({ type: 'response.create' }));
      }, 250);
    };
    
    // Handle user interruption
    const handleUserInterruption = () => {
      if (isAssistantSpeaking && lastAssistantItem) {
        const now = Date.now();
        
        // Minimum kesinti s√ºresini kontrol et
        if (!interruptionStartTime) {
          interruptionStartTime = now;
          return;
        }
        
        if (now - interruptionStartTime >= MIN_INTERRUPTION_TIME) {
          console.log('üî™ Kullanƒ±cƒ± s√∂z√º kesti');
          
          // OpenAI'ye kesinti bildir
          const truncateEvent = {
            type: 'conversation.item.truncate',
            item_id: lastAssistantItem,
            content_index: 0,
            audio_end_ms: Math.floor((latestMediaTimestamp - responseStartTimestamp) * 0.8)
          };
          openAiWs.send(JSON.stringify(truncateEvent));
          
          // Twilio buffer'ƒ± temizle
          clearTwilioBuffer();
          
          // State'i sƒ±fƒ±rla
          lastAssistantItem = null;
          responseStartTimestamp = null;
          isAssistantSpeaking = false;
          interruptionStartTime = null;
        }
      }
    };
    
    // ==================== OPENAI WEBSOCKET EVENTS ====================
    
    openAiWs.on('open', () => {
      console.log('‚úÖ OpenAI Realtime API baƒülantƒ±sƒ± kuruldu');
      setTimeout(configureSession, 100);
    });
    
    openAiWs.on('message', (data) => {
      try {
        const response = JSON.parse(data);
        
        if (LOG_EVENT_TYPES.includes(response.type)) {
          console.log(`üì® Event: ${response.type}`);
        }
        
        switch (response.type) {
          case 'session.created':
            console.log('‚úÖ Oturum olu≈üturuldu');
            break;
            
          case 'response.audio.delta':
            if (response.delta) {
              isAssistantSpeaking = true;
              
              // Track response start time
              if (!responseStartTimestamp) {
                responseStartTimestamp = latestMediaTimestamp;
                console.log('üé§ Eda konu≈ümaya ba≈üladƒ±');
              }
              
              // Store item ID for interruption handling
              if (response.item_id) {
                lastAssistantItem = response.item_id;
              }
              
              // Convert PCM16 to Œº-law
              const pcm16Buffer = Buffer.from(response.delta, 'base64');
              const ulawBuffer = pcm16ToUlaw(pcm16Buffer);
              const ulawBase64 = ulawBuffer.toString('base64');
              
              // Send audio to Twilio
              const audioMessage = {
                event: 'media',
                streamSid: streamSid,
                media: { payload: ulawBase64 }
              };
              connection.send(JSON.stringify(audioMessage));
              
              // Send mark for tracking
              sendMark();
            }
            break;
            
          case 'response.done':
            isAssistantSpeaking = false;
            console.log('‚úÖ Eda konu≈ümayƒ± bitirdi');
            break;
            
          case 'input_audio_buffer.speech_started':
            isUserSpeaking = true;
            console.log('üéôÔ∏è Kullanƒ±cƒ± konu≈ümaya ba≈üladƒ±');
            handleUserInterruption();
            break;
            
          case 'input_audio_buffer.speech_stopped':
            isUserSpeaking = false;
            interruptionStartTime = null;
            console.log('üîá Kullanƒ±cƒ± konu≈ümayƒ± bitirdi');
            break;
            
          case 'error':
            console.error('‚ùå OpenAI Hatasƒ±:', response.error);
            break;
        }
      } catch (error) {
        console.error('‚ùå OpenAI mesaj i≈üleme hatasƒ±:', error, 'Data:', data.toString());
      }
    });
    
    openAiWs.on('error', (error) => {
      console.error('‚ùå OpenAI WebSocket hatasƒ±:', error);
    });
    
    openAiWs.on('close', () => {
      console.log('üîå OpenAI baƒülantƒ±sƒ± kapandƒ±');
    });
    
    // ==================== TWILIO WEBSOCKET EVENTS ====================
    
    connection.on('message', (message) => {
      try {
        const data = JSON.parse(message);
        
        switch (data.event) {
          case 'start':
            streamSid = data.start.streamSid;
            console.log('üìû Twilio stream ba≈üladƒ±:', streamSid);
            console.log('üìä √áaƒürƒ± detaylarƒ±:', {
              callSid: data.start.callSid,
              accountSid: data.start.accountSid,
              from: data.start.customParameters?.from || 'Bilinmiyor',
              to: data.start.customParameters?.to || 'Bilinmiyor'
            });
            break;
            
          case 'media':
            latestMediaTimestamp = data.media.timestamp;
            
            // Forward audio to OpenAI (already in Œº-law format)
            if (openAiWs.readyState === WebSocket.OPEN && sessionConfigured) {
              const audioAppend = {
                type: 'input_audio_buffer.append',
                audio: data.media.payload
              };
              openAiWs.send(JSON.stringify(audioAppend));
            }
            break;
            
          case 'mark':
            // Remove processed mark from queue
            if (markQueue.length > 0) {
              markQueue.shift();
            }
            break;
            
          case 'stop':
            console.log('üìû √áaƒürƒ± sonlandƒ±');
            if (openAiWs.readyState === WebSocket.OPEN) {
              openAiWs.close();
            }
            break;
            
          default:
            // console.log('üì® Diƒüer Twilio event:', data.event);
            break;
        }
      } catch (error) {
        console.error('‚ùå Twilio mesaj i≈üleme hatasƒ±:', error);
      }
    });
    
    connection.on('close', () => {
      console.log('üëã Twilio baƒülantƒ±sƒ± kapandƒ±');
      if (openAiWs.readyState === WebSocket.OPEN) {
        openAiWs.close();
      }
    });
    
    connection.on('error', (error) => {
      console.error('‚ùå Twilio WebSocket hatasƒ±:', error);
    });
  });
});

// ==================== START SERVER ====================

fastify.listen({ port: PORT, host: '0.0.0.0' }, (err) => {
  if (err) {
    console.error('‚ùå Sunucu ba≈ülatƒ±lamadƒ±:', err);
    process.exit(1);
  }
  
  console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     üéâ EDA SESLƒ∞ ASƒ∞STAN SUNUCUSU HAZIR! üéâ      ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                  ‚ïë
‚ïë  üìç Port: ${PORT}                                  ‚ïë
‚ïë  üé§ Ses: ${VOICE}                              ‚ïë
‚ïë  üë© Karakter: Eda                                ‚ïë
‚ïë  üè¢ Firma: Ferled                                ‚ïë
‚ïë  üë®‚Äçüíª Yaratƒ±cƒ±: Botan √ñzalp                       ‚ïë
‚ïë                                                  ‚ïë
‚ïë  ‚úÖ T√ºm sistemler hazƒ±r!                         ‚ïë
‚ïë  üìû Aramalar bekleniyor...                       ‚ïë
‚ïë                                                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  `);
});
